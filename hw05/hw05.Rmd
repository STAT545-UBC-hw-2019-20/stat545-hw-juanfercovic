---
title: "STAT 545A Assignment 05: Factor and figure management"
output:
  html_document: default
  #pdf_document: default
---

```{r message=FALSE, warning=TRUE}
library(tidyverse)
library(ggplot2)
library(gapminder)
library(gridExtra)
library(grid)
library(spelling)
library(here)
library(readxl)
library(gridExtra)
library(grid)
knitr::opts_chunk$set(echo = TRUE)
```


## Exercise 1: Explain the value of the here::here package (10%)

  Read through the blog post by Malcolm Barrett where he outlines why one should use the here::here package in RStudio projects. Task: In your own words, summarize the value of the here::here package in 250 words or fewer.
  
  The great advantage of the 'here::here' package comes from the hability to define directories and read files in them without the necessity of wtriting explicitly the exact address to the folder, which is conditional to the operative system (ie: MAC or Windows), but only give information about the folder names and files. This way of setting a directory is extremely powerful since the researcher's only needs to pay attention to have a consistency in the folder names and the file names. This makes an R code very easy to be shared.
  Also, when you load the 'here' package (ie: 'library(here)'), is automatically setting the directory where your Rmd file is saved. This really handy because usually each researcher will decide a particular folder in his computer to save the code and datasets.
  

```{r}
ghg <- read_excel(here::here("hw05", "data", "ghgcanada.xlsx"), trim_ws = TRUE)

ghg
#ghg %>%
#  DT::datatable()


```


## Exercise 2: Factor management (20%)

Task: Choose one dataset (of your choice) and a variable to explore. After ensuring the variable(s) you’re exploring are indeed factors, you should:

Drop factor / levels;
  1. Reorder levels based on knowledge from data.
  2. We’ve elaborated on these steps for the gapminder and singer data sets below.

The dataset I will explore is the data from Fercovic and Gulati (2016) about CMA consumption of gasoline, electricity and natural gas from 1997-2009


```{r}
ghg$cma %>% 
class()
ghg$province %>% 
class()

#both cma and province are not factor so I will turn them into factors:
ghg$cma <- factor(ghg$cma)
ghg$province <- factor(ghg$province)
```


I can see if the variable cma is a factor with the following command:

```{r}
ghg$cma %>% 
class() 
ghg$province %>% 
class()
```

And describe the Provinces as factors in the following figure:
```{r}
ghg %>%
  ggplot() +
  geom_bar(aes(fct_infreq(province))) + 
  coord_flip()+
  theme_bw() +
  ylab("Nr. of entries") + xlab("Province")
```

And describe the CMAs as factors in the following figure:
```{r}
ghg %>%
  ggplot(aes(x=cma, y=gasemi)) +
  geom_bar(stat="identity", width=0.5) + 
  coord_flip()+
  theme_bw() +
  ylab("Nr. of entries") + xlab("Av. CO2 emissions from gasoline onsumption")

```
We can also create levels of the variable price of electricity:

 - First I will look at the variation of prices by province and overall:
```{r}
ggplot(ghg, aes(year, electric_price)) +
  geom_point(alpha = 0.2) +
  scale_x_log10(labels = scales::comma_format()) +
  facet_wrap(~province, scales = "free") + # this scale argument lets x and y axes be different for each plot
   ylab("Av. Electricity Price cents/KwH") + xlab("Year")
ggplot(ghg, aes(year, electric_price)) +
  geom_point(alpha = 0.2) +
  scale_x_log10(labels = scales::comma_format()) +
  #facet_wrap(~province, scales = "free") + # this scale argument lets x and y axes be different for each plot
   ylab("Av. Electricity Price cents/KwH") + xlab("Year")
```

Then I will select a few thresholds to create 3 levels of prices. I will illustrate the levels plotting Electricity consumption against the price in levels. As observed in the figure below, consumption is inversely correlated to prices.
```{r}
ghg %>% 
  mutate(electric_price_level = factor(case_when(electric_price < 7.5 ~ 'low',
                                electric_price < 10 ~ 'moderate',
                                electric_price < 12.5 ~ 'high',
                                TRUE ~ 'high'),
                             levels = c("low", "moderate", "high"))) %>% 
  ggplot() + geom_boxplot(aes(x = electric_price_level, y = Qelectricity)) +
  labs(y = "Electricity Cons. KwH", x= "Electricity price cents/KwH") +
  theme_bw()  + 
  scale_x_discrete(drop=FALSE) #makes that the value we dont have info shows in the graph
```


Explore the effects of re-leveling a factor in a tibble by:

  1. comparing the results of arrange on the original and re-leveled factor.
  2. Plotting a figure of before/after re-leveling the factor (make sure to assign the factor to an aesthetic of your choosing).
  
Here I will add more levels to the variable electricity price:

```{r}
ghg %>% 
  mutate(electric_price_level = factor(case_when(electric_price < 7.5 ~ 'very low',
                                electric_price < 10 ~ 'low',
                                electric_price < 12.5 ~ 'moderate',
                                electric_price < 15 ~ 'high',
                                TRUE ~ 'very high'),
                             levels = c("very low", "low", "moderate", "high", "very high"))) %>% 
  ggplot() + geom_boxplot(aes(x = electric_price_level, y = Qelectricity)) +
  labs(y = "Electricity Cons. KwH", x= "Electricity price cents/KwH") +
  theme_bw()  + 
  scale_x_discrete(drop=FALSE) #makes that the value we dont have info shows in the graph
```


  Also I will re-organize the factor for some CMAs. Let's say I would like to start the list with the CMAs in British Columbia: Vancouver and Victoria:
  
```{r}
ghg %>%
  ggplot() +
  geom_bar(aes(fct_relevel(cma, "Vancouver", "Victoria"))) + 
  coord_flip()+
  theme_bw() +
  ylab("Nr. of entries") + xlab("Census Metropolitan Areas")
```
  
  
  
  
  
  
  
  
  
  
  
  
## Exercise 3: File input/output (I/O) (20%)

Task: Experiment with at least one of:
  * write_csv()/read_csv() (and/or TSV friends),
  * saveRDS()/readRDS(),
  * dput()/dget().
You are expected to create something new, probably by filtering or grouped-summarization of your dataset (for e.g., Singer, Gapminder, or another dataset), export it to disk and then reload it back in using one of the packages above. You should use here::here() for reading in and writing out.

With the imported data, play around with factor levels and use factors to order your data with one of your factors (i.e. non-alphabetically). For the I/O method(s) you chose, comment on whether or not your newly created file survived the round trip of writing to file then reading back in.


I will keep using the data from Fercovic and Gulati (2006) for this task. 

1 I have imported the data in exercise 1 using 'read_excel'. From this file I called "ghg", I will summarize the CMA data in the averages of the sample years and the save in other formats

```{r}
ghg %>%
  select(cma, year, province, gasemi, elecemi, ngemi) %>%
  group_by(cma) %>%
  summarise(gasemi_mean = mean(gasemi),
            gasemi_sd = sd(gasemi),
            elecemi_mean = mean(elecemi),
            elecemi_sd = sd(elecemi)) %>%
  write.csv(file = "ghg_sum.csv",row.names=FALSE)
  


read_csv("ghg_sum.csv", col_names = TRUE, col_types = NULL)
```














## Exercise 4: Visualization design (20%)

Go back through your previous assignments and class participation activities and find figures you created prior to the last week of the course. Recreate at least one figure in light of something you learned in the recent class meetings about visualization design and color.

Task: Create a side-by-side plot and juxtapose your first attempt (show the original figure as-is) with a revised attempt after some time spent working on it and implementing principles of effective plotting principles. Comment and reflect on the differences.

For this task I will use the scatterplot ofvlife expectancy in time by continent from 'cm002' 

```{r}
oldg <- gapminder %>%
ggplot(aes(year, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7) +
  scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  facet_wrap(~continent) +
  theme(legend.position = 'none')


#My improved version is as follows:

newg <- gapminder %>%
  ggplot(aes(year,lifeExp)) + 
        geom_point(alpha = 0.3) + 
        geom_smooth(method = "lm", se = T,  formula = y ~ poly(I(x-1952), degree = 2)) +
        facet_wrap(~continent)


  grid.arrange(oldg, newg, nrow = 1)

```



```{r}
newg <- gapminder %>%
  ggplot(aes(year,lifeExp)) + 
        geom_point(alpha = 0.3) + 
        geom_smooth(method = "lm", se = T,  formula = y ~ poly(I(x-1952), degree = 2)) +
        facet_wrap(~continent)
```




```{r}
gapminder %>%
  group_by(continent, year) %>%
   summarise(lifeExp_average = mean(lifeExp), 
      lifeExp_sd = sd(lifeExp)) %>%
ggplot(aes(year, lifeExp_average)) +
  geom_errorbar(ymin=lifeExp_average-ci, ymax=lifeExp_average+ci, width=.1, position=pd) +
  #geom_boxplot() +
  geom_point(alpha = 0.7) +
 # scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  #scale_x_log10() +
  facet_wrap(~continent) +
  theme(legend.position = 'none')+
  theme_classic()

```




```{r}
ex <- gapminder %>% 
group_by(continent) %>% 
summarize(mean=mean(gdpPercap),
          min=min(gdpPercap),
          max=max(gdpPercap))

exg <- ex %>%
  ggplot(aes(continent)) +
  geom_point(aes(y = mean, colour = "mean")) + 
  geom_point(aes(y = min, colour = "min")) +
  geom_point(aes(y = max, colour = "max")) +
  ggtitle("continents")

  grid.arrange( exg, tableGrob(ex[1:4, 1:2]), nrow = 1, widths = 3:1)
```








## Exercise 5: Writing figures to file (10%)

Task: Use ggsave() to explicitly save a plot to file. Include the exported plot as part of your repository and assignment.

Then, use `![Alt text](/path/to/img.png)` to load and embed that file into your report. You can play around with various options, such as:

  * Arguments of ggsave(), such as width, height, resolution or text scaling.
  * Various graphics devices, e.g. a vector vs. raster format.
  * Explicit provision of the plot object p via ggsave(..., plot = p). Show a situation in which this actually matters.






ggsave(file="myplot.png")
































  
  
  
  
  
  
  
  
  
  
  
  
  
  
  